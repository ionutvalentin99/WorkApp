{% extends 'base.html.twig' %}

{% block title %}Work App | Dashboard{% endblock %}

{% block body %}
    {% set totalMinutes = 0 %}
    {% set countRecords = 0 %}
    {% if pontaje is defined %}
        {% for p in pontaje %}
            {% set diff = date(p.timeEnd).diff(date(p.timeStart)) %}
            {% set totalMinutes = totalMinutes + (diff.h * 60) + diff.i %}
            {% set countRecords = countRecords + 1 %}
        {% endfor %}
    {% endif %}
    {% set totalHours = (totalMinutes / 60)|round(1, 'floor') %}

    <div class="text-white pb-5 pt-4 shadow-lg"
         style="background: linear-gradient(135deg, #4F46E5 0%, #7C3AED 100%);">

        <div class="container pb-4">
            <div class="d-flex justify-content-between align-items-end flex-wrap gap-3">
                <div>
                    {% set hour = "now"|date("H") %}
                    <span class="badge bg-white bg-opacity-25 text-white mb-2 fw-normal">
                        <i class="bi bi-calendar-event me-1"></i> {{ "now"|date("l, d F Y") }}
                    </span>
                    <h1 class="fw-bold display-5 mb-1">
                        {% if app.user %}
                            {% if hour < 12 %}Good morning,{% elseif hour < 18 %}Good afternoon,{% else %}Good evening,{% endif %}
                            {{ app.user.firstName }}!
                        {% else %}
                            Welcome to ePontaj
                        {% endif %}
                    </h1>
                    {% if app.user %}
                    <p class="lead text-white text-opacity-75 mb-0">Here is what's happening today.</p>
                    {% else %}
                    <p class="lead text-white text-opacity-75 mb-0">Please log in to start</p>
                    {% endif %}
                </div>

                {% if app.user and app.user.company %}
                    <div class="bg-white bg-opacity-10 rounded-3 p-3 d-flex align-items-center border border-white border-opacity-25">
                        <div class="d-flex align-items-center justify-content-center bg-white text-primary rounded-3 p-2 me-3" style="width: 48px; height: 48px;">
                            <i class="bi bi-building fs-4"></i>
                        </div>
                        <div>
                            <small class="d-block text-uppercase text-white text-opacity-75" style="font-size: 0.75rem;">Company</small>
                            <span class="fw-bold fs-5">{{ app.user.company.name }}</span>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    {# ================= MAIN CONTENT CONTAINER ================= #}
    <div class="container" style="margin-top: -3rem;">

        {# ================= ALERTS ================= #}
        {% if app.request.query.get('error') %}
            <div class="alert alert-danger shadow-sm border-0 rounded-3 mb-4 d-flex align-items-center">
                <i class="bi bi-exclamation-octagon-fill fs-4 me-3"></i>
                <div>
                    <strong>Error encountered:</strong> {{ app.request.query.get('error') }}
                </div>
            </div>
        {% endif %}

        {# ================= NO COMPANY STATE ================= #}
        {% if app.user and not app.user.company %}
            <div class="card border-0 shadow rounded-4 mb-4 text-center">
                <div class="card-body p-5">
                    <div class="mb-4">
                        {# Folosim o culoare inline pentru iconita mov, sau text-primary daca preferi albastru #}
                        <div class="d-inline-flex align-items-center justify-content-center bg-light rounded-circle p-4" style="color: #4F46E5">
                            <i class="bi bi-buildings display-6"></i>
                        </div>
                    </div>
                    <h3 class="fw-bold text-dark">Nu ești încă într-o companie</h3>
                    <p class="text-muted mb-4 mx-auto w-50">
                        Pentru a începe pontajul, trebuie să te alături unei echipe existente sau să creezi propria ta companie.
                    </p>
                    <a href="{{ path('app_company_new') }}" class="btn btn-lg rounded-pill px-5 text-white" style="background-color: #4F46E5;">
                        <i class="bi bi-plus-lg me-1"></i> Creează sau Caută Companie
                    </a>
                </div>
            </div>
        {% endif %}

        {# ================= DASHBOARD GRID ================= #}
        {% if app.user and app.user.company %}
            <div class="row g-4 mb-4">

                {# --- CARD 1: PONTAJ RAPID --- #}
                <div class="col-lg-4">
                    <div class="card border-0 shadow-sm rounded-4 h-100">
                        <div class="card-body p-4">
                            <div class="d-flex align-items-center mb-3">
                                <div class="d-inline-flex align-items-center justify-content-center text-white rounded-3 p-3 me-3" style="background-color: #4F46E5;">
                                    <i class="bi bi-clock-fill fs-5"></i>
                                </div>
                                <h5 class="fw-bold mb-0">Pontaj Rapid</h5>
                            </div>
                            <p class="text-muted small mb-4">Începe o sesiune de lucru sau adaugă ore manual.</p>
                            <div class="d-grid">
                                <a href="{{ path('app_pontaj_new') }}" class="btn rounded-pill text-white" style="background-color: #4F46E5;">
                                    <i class="bi bi-play-circle me-2"></i> Adaugă Pontaj
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

                {# --- CARD 2: TOTAL ORE --- #}
                <div class="col-lg-4">
                    <div class="card border-0 shadow-sm rounded-4 h-100">
                        <div class="card-body p-4">
                            <div class="d-flex align-items-center mb-3">
                                <div class="d-inline-flex align-items-center justify-content-center bg-success text-white rounded-3 p-3 me-3">
                                    <i class="bi bi-bar-chart-fill fs-5"></i>
                                </div>
                                <h5 class="fw-bold mb-0">Total Ore</h5>
                            </div>
                            <div class="d-flex align-items-end">
                                <h2 class="fw-bold mb-0 me-2">{{ totalHours }}<small class="fs-6 text-muted">h</small></h2>
                                <span class="text-muted small mb-1">din {{ countRecords }} intrări</span>
                            </div>
                        </div>
                    </div>
                </div>

                {# --- CARD 3: ISTORIC --- #}
                <div class="col-lg-4">
                    <div class="card border-0 shadow-sm rounded-4 h-100">
                        <div class="card-body p-4">
                            <div class="d-flex align-items-center mb-3">
                                <div class="d-inline-flex align-items-center justify-content-center bg-secondary text-white rounded-3 p-3 me-3">
                                    <i class="bi bi-archive-fill fs-5"></i>
                                </div>
                                <h5 class="fw-bold mb-0">Istoric</h5>
                            </div>
                            <p class="text-muted small mb-4">Vezi rapoarte detaliate și exportă date.</p>
                            <div class="d-grid">
                                <a href="{{ path('app_pontaj') }}" class="btn btn-outline-secondary rounded-pill">
                                    Vezi Tot
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            {# ================= RECENT RECORDS TABLE ================= #}
            <div class="card border-0 shadow-sm rounded-4 overflow-hidden mb-5">
                <div class="card-header bg-white p-4 border-bottom d-flex justify-content-between align-items-center">
                    <h5 class="fw-bold mb-0">Pontaje Recente</h5>
                    <span class="badge bg-light text-dark border rounded-pill px-3">Ultimele intrări</span>
                </div>

                {% if pontaje is defined and pontaje|length > 0 %}
                    {# --- VARIANTĂ DESKTOP: Tabel (vizibil doar de la md în sus) --- #}
                    <div class="table-responsive d-none d-md-block">
                        <table class="table align-middle mb-0 table-hover">
                            <thead class="bg-light text-muted small text-uppercase">
                            <tr>
                                <th class="ps-4 py-3 border-0">Data</th>
                                <th class="py-3 border-0">Interval</th>
                                <th class="py-3 border-0">Durată</th>
                                <th class="py-3 border-0">Detalii</th>
                                <th class="text-end pe-4 py-3 border-0">Acțiuni</th>
                            </tr>
                            </thead>
                            <tbody class="border-top-0">
                            {% for pontaj in pontaje %}
                                {% set diff = date(pontaj.timeEnd).diff(date(pontaj.timeStart)) %}
                                <tr>
                                    <td class="ps-4 py-3">
                                        <div class="d-flex align-items-center">
                                            <div class="d-flex align-items-center justify-content-center bg-light rounded-circle me-3" style="width: 40px; height: 40px; color: #4F46E5;">
                                                <span class="fw-bold small">{{ pontaj.timeStart|date('d') }}</span>
                                            </div>
                                            <div>
                                                <div class="fw-bold text-dark">{{ pontaj.timeStart|date('F') }}</div>
                                                <div class="small text-muted">{{ pontaj.timeStart|date('l') }}</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="py-3">
                                        <span class="badge bg-light text-dark border fw-normal">{{ pontaj.timeStart|date('H:i') }}</span>
                                        <i class="bi bi-arrow-right text-muted mx-1 small"></i>
                                        <span class="badge bg-light text-dark border fw-normal">{{ pontaj.timeEnd|date('H:i') }}</span>
                                    </td>
                                    <td class="py-3">
                                        <span class="fw-bold text-success">{{ diff|date('%h') }}h {{ diff|date('%i') }}m</span>
                                    </td>
                                    <td class="py-3 text-muted small">{{ pontaj.details|default('—') }}</td>
                                    <td class="text-end pe-4 py-3">
                                        <div class="btn-group">
                                            <a href="{{ path('app_pontaj_update', {id: pontaj.id}) }}" class="btn btn-sm btn-light text-secondary"><i class="bi bi-pencil-square"></i></a>
                                            <a href="{{ path('app_pontaj_delete', {id: pontaj.id}) }}" class="btn btn-sm btn-light text-danger" onclick="return confirm('Sigur ștergi?')"><i class="bi bi-trash"></i></a>
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    {# --- VARIANTĂ MOBIL: Listă de Carduri (vizibilă doar sub md) --- #}
                    <div class="d-md-none">
                        {% for pontaj in pontaje %}
                            {% set diff = date(pontaj.timeEnd).diff(date(pontaj.timeStart)) %}
                            <div class="p-3 border-bottom">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <div class="d-flex align-items-center">
                                        <div class="bg-light rounded-3 text-center p-2 me-3" style="min-width: 45px; color: #4F46E5; border: 1px solid #eee;">
                                            <div class="fw-bold lh-1">{{ pontaj.timeStart|date('d') }}</div>
                                            <small style="font-size: 0.7rem;" class="text-uppercase">{{ pontaj.timeStart|date('M') }}</small>
                                        </div>
                                        <div>
                                            <div class="fw-bold">{{ diff|date('%h') }}h {{ diff|date('%i') }}m</div>
                                            <small class="text-muted">{{ pontaj.timeStart|date('H:i') }} - {{ pontaj.timeEnd|date('H:i') }}</small>
                                        </div>
                                    </div>
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-light border-0" type="button" data-bs-toggle="dropdown">
                                            <i class="bi bi-three-dots-vertical"></i>
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end shadow-sm border-0">
                                            <li><a class="dropdown-item" href="{{ path('app_pontaj_update', {id: pontaj.id}) }}"><i class="bi bi-pencil me-2"></i> Editează</a></li>
                                            <li><a class="dropdown-item text-danger" href="{{ path('app_pontaj_delete', {id: pontaj.id}) }}" onclick="return confirm('Ștergi?')"><i class="bi bi-trash me-2"></i> Șterge</a></li>
                                        </ul>
                                    </div>
                                </div>
                                {% if pontaj.details %}
                                    <div class="small text-muted bg-light p-2 rounded">{{ pontaj.details }}</div>
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center py-5">
                        <i class="bi bi-clipboard2-x display-4 text-muted opacity-50 mb-3"></i>
                        <h5 class="fw-bold text-muted">Nu există date</h5>
                        <p class="text-muted small">Începe prin a adăuga un pontaj nou.</p>
                    </div>
                {% endif %}
            </div>
        {% endif %}
    </div>
{% endblock %}